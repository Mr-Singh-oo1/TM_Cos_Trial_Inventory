<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TM Cosmetic Inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <!-- DataTables -->
  <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">

  <style>
    :root {
      --sidebar-bg: #141a22;
      --sidebar-bg-2: #0f141a;
      --sidebar-text: #cbd5e1;
      --sidebar-accent: #00c2ff;
      --sidebar-hover: #1b2430;
      --content-bg: #0b1220;
      --card-bg: #0f172a;
      --text: #eceef0;
      --muted: #94a3b8;
      --primary: #22c55e;
      --primary-900: #14532d;
      --danger: #ef4444;
      --warning: #f59e0b;
      --border: #1f2a44;
      --chip: #1e293b;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: linear-gradient(180deg, #0b1220, #0a0f1a);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    a { color: inherit; text-decoration: none; }

    input, select, textarea {
      background-color: #fff;
      border: 1px solid #ccc;
      padding: 6px 10px;
      border-radius: 4px;
      width: 100%;
    }

    label {
      font-weight: 500;
      margin-bottom: 4px;
      display: block;
    }

    .grid.cols-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    .app {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 260px;
      background: linear-gradient(180deg, var(--sidebar-bg), var(--sidebar-bg-2));
      border-right: 1px solid var(--border);
      transition: width 0.25s ease;
      position: sticky;
      top: 0;
      height: 100vh;
    }

    .sidebar.collapsed { width: 76px; }

    .sidebar-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 14px;
      border-bottom: 1px solid var(--border);
    }

    .burger {
      width: 40px;
      height: 40px;
      display: grid;
      place-items: center;
      background: #0b1118;
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      color: var(--sidebar-text);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      overflow: hidden;
      white-space: nowrap;
    }

    .brand .logo {
      width: 36px;
      height: 36px;
      display: grid;
      place-items: center;
      border-radius: 10px;
      background: radial-gradient(100% 100% at 100% 0%, #3b82f6 0%, #22d3ee 80%);
      color: white;
    }

    .brand .title { font-weight: 700; letter-spacing: .2px; }

    .sidebar.collapsed .brand .title { display: none; }

    .nav {
      padding: 10px 8px;
    }

    .nav .group-label {
      font-size: 12px;
      color: var(--muted);
      padding: 8px 10px;
      text-transform: uppercase;
      letter-spacing: .08em;
    }

    .nav a.item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 12px;
      margin: 6px 6px;
      border-radius: 10px;
      color: var(--sidebar-text);
      transition: background .2s ease, color .2s ease;
    }

    .nav a.item:hover {
      background: var(--sidebar-hover);
      color: #fff;
    }

    .nav a.item.active {
      background: linear-gradient(180deg,#18212e,#1e293b);
      color: #fff;
      border: 1px solid #203147;
    }

    .nav a .icon {
      width: 42px;
      height: 42px;
      display: grid;
      place-items: center;
      background: #121926;
      border: 1px solid var(--border);
      border-radius: 10px;
      color: #8ab4ff;
      flex: 0 0 auto;
    }

    .nav a .label {
      overflow: hidden;
      white-space: nowrap;
    }

    .sidebar.collapsed .nav a .label { display: none; }

    .content {
      flex: 1;
      min-width: 0;
      padding: 24px;
      transition: all 0.3s ease;
    }

    .section {
      display: none;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .section.active {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
    /* DataTables: Entries dropdown */
    #inventory-list .dataTables_length label,
    #inventory-list .dataTables_length select {
      background-color: #18232e;
      color: #c8c9cb !important;
      font-weight: 500;
      font-size: 13px;
    }

    /* DataTables: Pagination buttons */
    #inventory-list .dataTables_paginate .paginate_button {
      background-color: #f1f5f9;
      border: 1px solid #cbd5e1;
      color: #1e293b !important;
      padding: 6px 12px;
      margin: 0 4px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      transition: background-color 0.2s ease;
    }

    #inventory-list .dataTables_paginate .paginate_button.current {
      background-color: #e2e8f0;
      font-weight: bold;
    }

    #inventory-list .dataTables_paginate .paginate_button:hover {
      background-color: #dbeafe;
      color: #0f172a !important;
    }

    /* DataTables: Table grid */
    #inventory-list table.dataTable {
      border-collapse: collapse;
      border: 1px solid #cbd5e1;
    }

    #inventory-list table.dataTable th,
    #inventory-list table.dataTable td {
      border: 1px solid #e2e8f0;
      padding: 8px;
      text-align: left;
    }

    @media (max-width: 768px) {
      .app {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        height: auto;
      }

      .content {
        padding: 12px;
      }

      .grid.cols-3 {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
      <div class="sidebar-header">
        <button id="toggleSidebar" class="burger" title="Toggle sidebar">
          <i class="fa-solid fa-bars"></i>
        </button>
        <div class="brand">
          <div class="logo"><i class="fa-solid fa-flask"></i></div>
          <div class="title">TM Cosmetic Inventory</div>
        </div>
      </div>

      <nav class="nav">
        <div class="group-label">Main</div>
        <a href="#" class="item active" data-target="dashboard">
          <div class="icon tip"><i class="fa-solid fa-chart-pie"></i></div>
          <div class="label">Dashboard</div>
        </a>
        <a href="#" class="item" data-target="inventory-form">
          <div class="icon"><i class="fa-solid fa-plus-square"></i></div>
          <div class="label">Inventory form</div>
        </a>
        <a href="#" class="item" data-target="inventory-list">
          <div class="icon"><i class="fa-solid fa-boxes-stacked"></i></div>
          <div class="label">Inventory</div>
        </a>
        <a href="#" class="item" data-target="Selling-form">
          <div class="icon"><i class="fa-solid fa-cart-arrow-down"></i></div>
          <div class="label">Selling form</div>
        </a>
      </nav>
    </aside>

    <!-- Content -->
    <main class="content">
      <div class="page-header">
        <div>
          <h2 style="margin:0">Welcome back</h2>
          <div class="muted">Manage items, track batches, and keep stock fresh.</div>
        </div>
        <div class="chips">
          <span class="chip">Live</span>
          <span class="chip">Responsive</span>
          <span class="chip">GAS + Sheets</span>
        </div>
      </div>

      <!-- Dashboard -->
      <section id="dashboard" class="section active">
        <div class="card">
          <div class="card-header">
            <i class="fa-solid fa-chart-pie"></i>
            <strong style="margin-left:8px">Dashboard</strong>
          </div>
          <div class="card-body">
            <p class="muted">Coming soon — KPIs, low stock alerts, sales trend, expiry timeline.</p>
          </div>
        </div>
      </section>

      <!-- Inventory Form -->
      <section id="inventory-form" class="section active" style="background-color:#ffffff; padding:24px; color:#f0f0f0">
        <div class="card" style="background-color:#ffffff; border-radius:8px; box-shadow:0 2px 8px rgb(255, 255, 255); padding:20px">
          <div class="card-header" style="color:#1a1919">
            <i class="fa-solid fa-plus-square"></i>
            <strong style="margin-left:8px">Add Inventory Item</strong>
          </div>
          <div class="card-body">
            <form id="invForm" style="display:flex; flex-direction:column; gap:24px">
      
              <!-- Product Details -->
              <fieldset style="background:#f9f9f9; border:1px solid #ccc; padding:16px; border-radius:6px; color:#333">
                <legend><strong>Product Details</strong></legend>
                <div style="display:flex; flex-direction:column; gap:12px">
                  <label>Product ID <input type="text" name="product_id" id="product_id" required></label>
                  <label>Product Name <input type="text" name="product_name" id="product_name" required></label>
                  <label>Brand Name <input type="text" name="brand_name" id="brand_name"></label>
                  <label>Category <input type="text" name="category" id="category"></label>
                  <label>Subcategory <input type="text" name="subcategory" id="subcategory"></label>
                  <label>Product Unit <input type="text" name="unit_of_measurement" id="unit_of_measurement" placeholder="e.g., Bottle, Pack"></label>
                  <label>Size (ml) <input type="number" name="size_ml" id="size_ml"></label>
                </div>
              </fieldset>
      
              <!-- Pricing -->
              <fieldset style="background:#f9f9f9; border:1px solid #ccc; padding:16px; border-radius:6px; color:#333">
                <legend><strong>Pricing</strong></legend>
                <div style="display:flex; flex-direction:column; gap:12px">
                  <label>MRP <input type="number" step="0.01" name="mrp" id="mrp"></label>
                  <label style="display:flex; align-items:center; gap:10px">
                    <input type="checkbox" name="discount_eligible" id="discount_eligible" value="Yes" style="width:18px; height:18px"> Discount Eligible
                  </label>
                </div>
              </fieldset>
      
              <!-- Inventory Info -->
              <fieldset style="background:#f9f9f9; border:1px solid #ccc; padding:16px; border-radius:6px; color:#333">
                <legend><strong>Inventory Info</strong></legend>
                <div style="display:flex; flex-direction:column; gap:12px">
                  <label>Batch Number <input type="text" name="batch_number" id="batch_number"></label>
                  <label>Expiry Date <input type="date" name="expiry_date" id="expiry_date"></label>
                  <label>Reorder Level <input type="number" name="reorder_level" id="reorder_level"></label>
                </div>
              </fieldset>
      
              <!-- Meta Info -->
              <fieldset style="background:#f9f9f9; border:1px solid #ccc; padding:16px; border-radius:6px; color:#333">
                <legend><strong>Meta Info</strong></legend>
                <div style="display:flex; flex-direction:column; gap:12px">
                  <label>Tags <input type="text" name="tags" id="tags" placeholder="comma-separated"></label>
                  <label>Upload Product Image
                    <input type="file" name="product_image" id="product_image" accept="image/*" capture="environment">
                  </label>
                  <label style="display:flex; align-items:center; gap:10px">
                    <input type="checkbox" name="is_active" id="is_active" value="Yes" style="width:18px; height:18px"> Is Active
                  </label>
                </div>
              </fieldset>
      
              <!-- Buttons -->
              <div style="display:flex; gap:12px">
                <button type="submit" class="btn btn-primary"><i class="fa-solid fa-paper-plane"></i> Submit</button>
                <button type="reset" class="btn"><i class="fa-solid fa-eraser"></i> Clear</button>
                <div id="formStatus" class="muted" style="align-self:center; color:#ccc"></div>
              </div>
            </form>
          </div>
        </div>
      </section>  

      <!-- Inventory List -->
      <section id="inventory-list" class="section">
        <div class="card" style="margin-bottom:14px">
          <div class="card-header"><i class="fa-solid fa-filter"></i> <strong style="margin-left:8px">Filters</strong></div>
          <div class="card-body">
            <div class="filters">
              <div>
                <label>Product_id</label>
                <input type="text" id="f_product_id">
              </div>
              <div>
                <label>ProductName</label>
                <input type="text" id="f_product">
              </div>
              <div>
                <label>ExpiryDate</label>
                <input type="date" id="f_expiry">
              </div>
              <div>
                <label>BatchNumber</label>
                <input type="text" id="f_batch">
              </div>
              <div>
                <label>DiscountEligible</label>
                <select id="f_discount">
                  <option value="">All</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
            </div>
            <div style="display:flex; gap:10px; margin-top:8px;">
              <button id="btnClearFilters" class="btn btn-ghost">
                <i class="fa-solid fa-broom"></i> Clear filters
              </button>
              <button id="btnRefreshInventory" class="btn btn-primary">
                <i class="fa-solid fa-rotate-right"></i> Refresh
              </button>
              <div id="tableStatus" class="muted" style="align-self:center"></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><i class="fa-solid fa-boxes-stacked"></i> <strong style="margin-left:8px">Inventory</strong></div>
          <div class="card-body">
            <div class="table-wrap">
              <table id="inventoryTable" class="display" style="width:100%">
                <thead>
                  <tr>
                    <th>Product_id</th>
                    <th>ProductName</th>
                    <th>Brand_id</th>
                    <th>size</th>
                    <th>unit_of_measurement</th>
                    <th>MRP</th>
                    <th>DiscountEligible</th>
                    <th>IsActive</th>
                    <th>BatchNumber</th>
                    <th>ExpiryDate</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Selling Form -->
      <section id="Selling-form" class="section">
        <div class="card">
          <div class="card-header" style="color:#ffffff; background-color:#1e293b;">
            <i class="fa-solid fa-cart-shopping"></i>
            <strong style="margin-left:8px">Record a Sale</strong>
          </div>
          <div class="card-body">
            <form id="saleForm" style="display:flex; flex-direction:column; gap:12px;">

              <!-- Product ID -->
              <label for="productId" style="color:#e0e0e0;">Product ID <span style="color:red">*</span></label>
              <input list="productIdList" id="productId" name="productId" required>
              <datalist id="productIdList"></datalist>

              <!-- Product Name -->
              <label for="productName" style="color:#e0e0e0;">Product Name <span style="color:red">*</span></label>
              <input list="productNameList" id="productName" name="productName" required>
              <datalist id="productNameList"></datalist>

              <!-- Price -->
              <label for="price" style="color:#e0e0e0;">Price <span style="color:red">*</span></label>
              <input type="number" id="price" name="price" step="0.01" required>

              <!-- Units Sold -->
              <label for="unitsSold" style="color:#e0e0e0;">Units Sold <span style="color:red">*</span></label>
              <input type="number" id="unitsSold" name="unitsSold" min="1" required>

              <!-- Customer Name (Optional) -->
              <label for="customerName" style="color:#e0e0e0;">Customer Name</label>
              <input type="text" id="customerName" name="customerName">

              <!-- Mobile Number (Optional) -->
              <label for="mobileNumber" style="color:#e0e0e0;">Mobile Number</label>
              <input type="tel" id="mobileNumber" name="mobileNumber" pattern="[0-9]{10}" placeholder="10-digit number">

              <!-- Payment Mode -->
              <label for="paymentMode" style="color:#e0e0e0;">Payment Mode <span style="color:red">*</span></label>
              <select id="paymentMode" name="paymentMode" required>
                <option value="">Select</option>
                <option value="Cash">Cash</option>
                <option value="Pending">Pending</option>
                <option value="Online">Online</option>
              </select>

              <!-- Buttons -->
              <div style="display:flex; gap:10px; align-items:center; margin-top:8px;">
                <button type="submit" class="btn btn-primary" style="padding:6px 12px; font-size:14px;">
                  <i class="fa-solid fa-save"></i> Save Sale
                </button>
                <button type="reset" class="btn" style="padding:6px 12px; font-size:14px;">
                  <i class="fa-solid fa-eraser"></i> Clear Fields
                </button>
                <div id="formStatus" class="muted" style="margin-left:10px;"></div>
              </div>

            </form>
          </div>
        </div>
      </section> 
    </main>
  </div>
  <!-- jQuery + DataTables -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <script>
    // === API Endpoints ===
    const INVENTORY_LIST_URL = "https://tm-cos-trial-inventory-2.onrender.com/submit-inventory";
    const SALES_API_URL = "https://your-render-app.onrender.com/submit-sale";
    const INVENTORY_FETCH_URL = "https://script.google.com/macros/s/AKfycbyZhQRHpyJdp3DUSnsNZE-jD0wkS69-hsj0AH8pUzWt_qQFLuKGyMFGYXhJfFMmOefq_g/exec?action=inventory";

    // === Sidebar Toggle ===
    const sidebar = document.getElementById('sidebar');
    document.getElementById('toggleSidebar').addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      if (window.inventoryDT) {
        setTimeout(() => window.inventoryDT.columns.adjust().draw(false), 300);
      }
    });

    // === SPA Navigation ===
    const navLinks = document.querySelectorAll('.nav a.item');
    const sections = document.querySelectorAll('.section');
    navLinks.forEach(link => {
      link.addEventListener('click', async (e) => {
        e.preventDefault();
        const target = link.getAttribute('data-target');
        navLinks.forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        sections.forEach(s => s.classList.remove('active'));
        document.getElementById(target).classList.add('active');

        if (target === 'inventory-list') await loadInventory();
        if (target === 'Selling-form') await loadSellingInventory();
      });
    });

    // === Inventory Form Submission ===
    const formEl = document.getElementById('invForm');
    const formStatus = document.getElementById('formStatus');

    if (formEl) {
      formEl.addEventListener('submit', async (e) => {
        e.preventDefault();
        formStatus.textContent = 'Submitting...';

        const fd = new FormData(formEl);
        const file = fd.get("product_image");

        let base64Image = "";
        if (file) {
          const reader = new FileReader();
          base64Image = await new Promise((resolve) => {
            reader.onload = () => resolve(reader.result.split(",")[1]);
            reader.readAsDataURL(file);
          });
        }

        const payload = {
          product_id: fd.get("product_id"),
          product_name: fd.get("product_name"),
          brand_name: fd.get("brand_name"),
          category: fd.get("category"),
          subcategory: fd.get("subcategory"),
          unit_of_measurment: fd.get("unit_of_measurment"),
          size_ml: fd.get("size_ml"),
          mrp: fd.get("mrp"),
          discount_eligible: fd.get("discount_eligible"),
          is_active: fd.get("is_active"),
          batch_number: fd.get("batch_number"),
          expiry_date: fd.get("expiry_date"),
          reorder_level: fd.get("reorder_level"),
          tags: fd.get("tags"),
          image_base64: base64Image,
          image_filename: file?.name || ""
        };

        try {
          const res = await fetch(INVENTORY_LIST_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const text = await res.text();
          formStatus.textContent = text.includes('Success') ? 'Saved ✅' : text;
          formEl.reset();

          if (document.getElementById('inventory-list')?.classList.contains('active')) {
            await loadInventory(true);
          }
        } catch (err) {
          formStatus.textContent = '❌ Error: ' + err.message;
        }
      });
    }

    // === Normalize Keys ===
    function normKey(k) {
      return String(k || '').toLowerCase().replace(/[\s_()]/g, '').replace(/name$/, 'name');
    }

    const COLS = [
      'product_id','productname','brand_id','size','unit_of_measurement','mrp',
      'discounteligible','isactive','batchnumber','expirydate'
    ];

    function toCanonical(rowObj) {
      const map = {};
      for (const [k, v] of Object.entries(rowObj)) map[normKey(k)] = v;
      return {
        product_id: map.productid || map['product_id'] || map['product id'] || map['product_code'] || '',
        productname: map.productname || map['product_name'] || '',
        brand_id: map.brandid || map['brand_id'] || map.brand || map.brandname || map['brand name'] || '',
        size: map.size || map['sizeml'] || map['size(ml)'] || map['size_ml'] || '',
        unit_of_measurement: map.unitofmeasurement || map['unit'] || map['productunit'] || map['unit_of_measurement'] || '',
        mrp: map.mrp || '',
        discounteligible: map.discounteligible || map['discounteligible?'] || map['discount_eligible'] || '',
        isactive: map.isactive || map['is_active'] || '',
        batchnumber: map.batchnumber || map['batch_number'] || '',
        expirydate: map.expirydate || map['expiry_date'] || ''
      };
    }
  </script>
  <script>
  // === Inventory Table Logic ===
  let rawData = [];
  let filtered = [];
  let initialized = false;
  const tableStatus = document.getElementById('tableStatus');

  async function fetchData() {
    try {
      if (tableStatus) tableStatus.textContent = 'Loading...';
      const res = await fetch("https://script.google.com/macros/s/AKfycbyZhQRHpyJdp3DUSnsNZE-jD0wkS69-hsj0AH8pUzWt_qQFLuKGyMFGYXhJfFMmOefq_g/exec");
      const json = await res.json();
      rawData = json.map(toCanonical).filter(r => r.product_id || r.productname);
      if (tableStatus) tableStatus.textContent = `Loaded ${rawData.length} items`;
    } catch (e) {
      if (tableStatus) tableStatus.textContent = 'Failed to load';
      console.error(e);
    }
  }

  function applyFilters() {
    const qProductId = document.getElementById('f_product_id')?.value.trim().toLowerCase() || '';
    const qProd = document.getElementById('f_product')?.value.trim().toLowerCase() || '';
    const qExpiry = document.getElementById('f_expiry')?.value || '';
    const qBatch = document.getElementById('f_batch')?.value.trim().toLowerCase() || '';
    const qDisc  = document.getElementById('f_discount')?.value || '';

    filtered = rawData.filter(r => {
      const okProductId = !qProductId || String(r.product_id || '').toLowerCase().includes(qProductId);
      const okProd  = !qProd  || String(r.productname || '').toLowerCase().includes(qProd);
      const okBatch = !qBatch || String(r.batchnumber || '').toLowerCase().includes(qBatch);
      const okDisc  = !qDisc  || String(r.discounteligible || '').toLowerCase() === qDisc.toLowerCase();
      let okExpiry = true;
      if (qExpiry) okExpiry = (String(r.expirydate || '').slice(0,10) === qExpiry);
      return okProductId && okProd && okBatch && okDisc && okExpiry;
    });
  }

  function renderTable() {
    const tbody = document.querySelector('#inventoryTable tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    filtered.forEach(r => {
      const tr = document.createElement('tr');
      const cells = [
        r.product_id, r.productname, r.brand_id, r.size, r.unit_of_measurement,
        r.mrp, r.discounteligible, r.isactive, r.batchnumber, r.expirydate
      ];
      cells.forEach(c => {
        const td = document.createElement('td');
        td.textContent = c == null ? '' : c;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    if (!initialized) {
      window.inventoryDT = $('#inventoryTable').DataTable({
        pageLength: 10,
        lengthMenu: [10, 25, 50, 100],
        order: [],
        responsive: true,
        dom: 'lfrtip'
      });
      initialized = true;
    } else {
      window.inventoryDT.clear();
      $('#inventoryTable tbody tr').each(function() {
        const rowData = Array.from(this.children).map(td => td.textContent);
        window.inventoryDT.row.add(rowData);
      });
      window.inventoryDT.draw(false);
    }
  }

  async function loadInventory(force = false) {
    if (!initialized || force) {
      await fetchData();
    }
    applyFilters();
    renderTable();
  }

  ['f_product_id','f_product','f_expiry','f_batch','f_discount'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('input', () => { applyFilters(); renderTable(); });
    el.addEventListener('change', () => { applyFilters(); renderTable(); });
  });

  const btnClearFilters = document.getElementById('btnClearFilters');
  if (btnClearFilters) {
    btnClearFilters.addEventListener('click', () => {
      ['f_brand','f_product','f_expiry','f_batch','f_discount'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      applyFilters(); renderTable();
    });
  }

  const btnRefreshInventory = document.getElementById('btnRefreshInventory');
  if (btnRefreshInventory) {
    btnRefreshInventory.addEventListener('click', async () => {
      tableStatus.textContent = 'Refreshing...';
      await loadInventory(true);
    });
  }

  // === Selling Form Logic ===
  async function loadSellingInventory() {
    try {
      const res = await fetch(INVENTORY_FETCH_URL);
      const data = await res.json();
      console.log('Selling inventory API data:', data);

      if (!data.ok || !Array.isArray(data.items)) {
        console.warn('No items returned for Selling inventory');
        return;
      }

      const idList = document.getElementById('productIdList');
      const nameList = document.getElementById('productNameList');
      if (!idList || !nameList) {
        console.error('Datalist elements not found in DOM');
        return;
      }

      idList.innerHTML = '';
      nameList.innerHTML = '';

      data.items.forEach(item => {
        if (item.id) {
          const optId = document.createElement('option');
          optId.value = item.id;
          idList.appendChild(optId);
        }
        if (item.name) {
          const optName = document.createElement('option');
          optName.value = item.name;
          nameList.appendChild(optName);
        }
      });

      console.log(`Populated ${idList.children.length} product IDs and ${nameList.children.length} product names`);
    } catch (err) {
      console.error('Error loading Selling inventory:', err);
    }
  }

  const saleForm = document.getElementById('saleForm');
  const saleFormStatus = document.getElementById('formStatus');

  if (saleForm) {
    saleForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (saleFormStatus) {
        saleFormStatus.style.color = '#1e293b';
        saleFormStatus.textContent = 'Saving...';
      }

      const payload = {
        productId: document.getElementById('productId')?.value.trim(),
        productName: document.getElementById('productName')?.value.trim(),
        price: parseFloat(document.getElementById('price')?.value),
        unitsSold: parseInt(document.getElementById('unitsSold')?.value, 10),
        customerName: document.getElementById('customerName')?.value.trim(),
        mobileNumber: document.getElementById('mobileNumber')?.value.trim(),
        paymentMode: document.getElementById('paymentMode')?.value
      };

      try {
        const res = await fetch(SALES_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (data.ok) {
          saleFormStatus.style.color = 'green';
          saleFormStatus.textContent = '✅ Sale recorded successfully!';
          saleForm.reset();
        } else {
          saleFormStatus.style.color = 'red';
          saleFormStatus.textContent = '❌ Error: ' + (data.message || 'Unknown error');
        }
      } catch (err) {
        saleFormStatus.style.color = 'red';
        saleFormStatus.textContent = '❌ Network error: ' + err.message;
      }
    });
  }

  // === Load Selling Inventory on Page Load ===
  window.addEventListener('DOMContentLoaded', loadSellingInventory);
</script>
</body>
</html>
